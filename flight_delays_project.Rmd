---
title: "Group Project: Flight Delays EDA"
author: "Cindy Zhao's Contribution to Group 4"
output: word_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
# This first chunk is for setup. 
# The 'include=FALSE' option means the code will run, but it won't be shown in the final document.
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## Summary

Analyzing and Predicting Flight Delays Using Bureau of Transportation Statistics Data

This project analyzes and predicts U.S. airline flight delays using the On-Time Performance dataset.The data include all of ~70,000 flights from July 2025 with fields such as airline, airport, date, scheduled and actual times, delay durations, and causes (weather, carrier, system, and late aircraft).

Delay Extremes: 

Identify airlines with the most and least delays (>15 min)
Identify airports with the most and least delays
Look at arrival delays (ARR_DEL15)

Delay Duration Dynamics:

Analyze the distribution of delay times through histograms
Highlight airlines/airports with the highest and lowest average delay durations

Temporal and Operational Patterns:

Visualize how delays vary by time of day and delay segments (using DEP_TIME_BLK and ARR_DELAY)
Examine how delays are caused by a previous event, showing how a "hotspot" spreads to the current flight (LATE_AIRCRAFT_DELAY)

## Data

The data is available from the Bureau of Transportation Statistics (BTS): https://transtats.bts.gov/DL_SelectFields.aspx?gnoyr_VQ=FGK&QO_fu146_anzr=b0-gvzr

```{r load-data, echo=FALSE}

# Load Libraries and Data
library(tidyverse)
library(flextable)
library(gridExtra)
library(ggExtra)

flight_delays_df <- read.csv("T_ONTIME_MARKETING.csv")
```

### Preview the data set

```{r df preview, echo=FALSE}

flight_delays_df %>%
  select(1:10) %>% 
  head(3) %>%
  flextable() %>%
  set_caption("Flight delays (first 3 rows and first 10 columns of dataset)") %>%
  fontsize(size = 6, part = "all")
```

## EDA (Exploratory Data Analysis) of arrival flight delays:

```{r EDA rates, echo=FALSE, fig.width=10, fig.height=5}
p1 <- flight_delays_df %>%
  filter(!is.na(ARR_DELAY)) %>% 
  ggplot(aes(x = ARR_DELAY)) +
  geom_histogram(binwidth = 15, fill = "#4c72b0", color = "black") +   geom_vline(aes(xintercept = mean(ARR_DELAY, na.rm = TRUE)), 
             color = "red", linetype = "dashed", linewidth = 1) +
  coord_cartesian(xlim = c(-60, 200)) + 
  labs(title = "Distribution of Arrival Delays (All Flights)",
       x = "Arrival Delay (minutes)",
       y = "Count of Flights") +
  theme_minimal()
p2 <- flight_delays_df %>%
  filter(!is.na(DEP_DELAY)) %>%
  
  ggplot(aes(x = DEP_DELAY)) +
  geom_histogram(binwidth = 15, fill = "#de524e", color = "black") +
  geom_vline(aes(xintercept = mean(DEP_DELAY, na.rm = TRUE)), 
             color = "red", linetype = "dashed", linewidth = 1) +
  coord_cartesian(xlim = c(-60, 200)) + 
  labs(title = "Distribution of Departure Delays (All Flights)",
       x = "Departure Delay (minutes)",
       y = "Count of Flights") +
  theme_minimal()
grid.arrange(p1, p2, ncol = 2)
```

\pagebreak

### Identify airlines with the most and least Arrival Delays (>15 min)

```{r P1Q1a, echo=FALSE} 

airline_delay_summary <- flight_delays_df %>%
  # Group by airline
  group_by(MKT_UNIQUE_CARRIER) %>%
  summarize(
    Total_Flights = n(),
    # Sum gives the total number of delays. 
    # ARR_DEL15 is 1 if a delay >= 15 min
    Total_Delayed_Flights = sum(ARR_DEL15, na.rm = TRUE),
    # Percentage of delayed flights
    Delay_Percentage = (Total_Delayed_Flights / Total_Flights) * 100
  )

# Airlines with the highest Delay_Percentage
most_delayed <- airline_delay_summary %>%
  arrange(desc(Delay_Percentage)) %>%
  slice_head(n = 9)

most_delayed %>%
  flextable() %>%
  set_caption("Airlines with the highest Delay_Percentage") %>%
autofit()
```
\pagebreak

```{r P1Q1b, echo=FALSE}
# Airline with the Lowest Delay_Percentage
least_delayed <- airline_delay_summary %>%
  arrange(Delay_Percentage) %>%
  slice_head(n = 9)

least_delayed %>%
  flextable() %>%
  set_caption("Airlines with the Lowest Delay_Percentage") %>%
autofit()
```

```{r, echo=FALSE, fig.width = 8}

top_delayed_carrier_codes <- most_delayed$MKT_UNIQUE_CARRIER 

daily_delay_trends3 <- flight_delays_df %>%
  filter(MKT_UNIQUE_CARRIER %in% top_delayed_carrier_codes) %>%
  select(MKT_UNIQUE_CARRIER, ARR_DELAY)

ggplot(data = daily_delay_trends3, aes(x = MKT_UNIQUE_CARRIER, y = ARR_DELAY)) +
  geom_boxplot(aes(fill = MKT_UNIQUE_CARRIER)) + 
  stat_summary(fun = median, geom = "point", shape = 23, size = 2, fill = "black") + 
  coord_cartesian(ylim = c(-30, 100)) + 
  labs(title = "Arrival Delay Distribution by Airline",
       x = "Airline Carrier",
       y = "Arrival Delay (minutes)")
```

### Identify destination airports with the most and least Arrival Delays (>15 min)

```{r P1Q2a, echo=FALSE} 

airport_delay_summary <- flight_delays_df %>%
  # Group by the Destination Airport
  group_by(DEST) %>%
  summarize(
    Total_Arrivals = n(),
    # Sum gives the total number of delays. 
    # ARR_DEL15 is 1 if a delay >= 15 min
    Total_Arrival_Delays = sum(ARR_DEL15, na.rm = TRUE),
    # Percentage of delayed flights
    Arrival_Delay_Percentage = (Total_Arrival_Delays / Total_Arrivals) * 100
  )

# Destination Airports with the highest Arrival_Delay_Percentage
most_delayed_arrivals <- airport_delay_summary %>%
  arrange(desc(Arrival_Delay_Percentage)) %>%
  slice_head(n = 9)

# Display the top 5 most delayed airports
most_delayed_arrivals %>%
  flextable() %>%
  set_caption("Destination Airports with the Highest Arrival Delay Percentage (>15 min)") %>%
  autofit()
```

\pagebreak

```{r P1Q2b, echo=FALSE}
# Destination Airports with the Lowest Arrival_Delay_Percentage
least_delayed_arrivals <- airport_delay_summary %>%
  arrange(Arrival_Delay_Percentage) %>%
  slice_head(n = 9)

# Display the top 5 least delayed airports
least_delayed_arrivals %>%
  flextable() %>%
  set_caption("Destination Airports with the Lowest Arrival Delay Percentage (>15 min)") %>%
  autofit()
```

```{r overall_increase, echo=FALSE, fig.width = 8}
top_delayed_carrier_codes2 <- most_delayed_arrivals$DEST 

daily_delay_trends4 <- flight_delays_df %>%
  filter(DEST %in% top_delayed_carrier_codes2) %>%
  select(DEST, ARR_DELAY)

ggplot(data = daily_delay_trends4, aes(x = DEST, y = ARR_DELAY)) +
  geom_boxplot(aes(fill = DEST)) + 
  stat_summary(fun = median, geom = "point", shape = 23, size = 2, fill = "black") + 
  coord_cartesian(ylim = c(-30, 100)) + 
  labs(title = "Arrival Delay Distribution by Destination Airport",
       x = "Airport",
       y = "Arrival Delay (minutes)")
```

### Histograms for the Most Delayed Destination Airports

```{r P1Q3h, echo=FALSE, fig.width = 8, fig.height = 4}

top_delayed_origins <- most_delayed_arrivals$DEST
data_for_plot <- flight_delays_df %>%
  filter(DEST %in% top_delayed_origins) %>%
 # Filter out missing delay values
  filter(ARR_DEL15 == 1, !is.na(ARR_DELAY))
mean_delays <- data_for_plot %>%
  group_by(DEST) %>%
  summarize(mean_delay = mean(ARR_DELAY, na.rm = TRUE))

#Plot
ggplot(data = data_for_plot, aes(x = ARR_DELAY)) +
  geom_histogram(binwidth = 15, fill = "steelblue", color = "black") +
 # The vertical line to show the mean population value
  geom_vline(data = mean_delays, 
             aes(xintercept = mean_delay), 
             color = "red", linetype = "dashed", linewidth = 1) +
  facet_wrap(~ DEST, scales = "free_y", ncol = 3) +
  labs(
    title = "Distribution of Arrival Delay (min) for Most Delayed Destination Airports",
    x = "Arrival Delay (minutes)", 
    y = "Frequency"
  ) +
  # Reasonable range for delays (0 to 200 minutes)
  xlim(0, 200) 
```

### Histograms for the Least Delayed Destination Airports

```{r P1Q3L, echo=FALSE, fig.width = 8, fig.height = 4}

least_delayed_origins <- least_delayed_arrivals$DEST
data_for_plot_least <- flight_delays_df %>%
  # Filter out missing delay values
  filter(DEST %in% least_delayed_origins, !is.na(ARR_DELAY))

mean_delays_least <- data_for_plot_least %>%
  group_by(DEST) %>%
  summarize(mean_delay = mean(ARR_DELAY, na.rm = TRUE))

#Plot
ggplot(data = data_for_plot_least, aes(x = ARR_DELAY)) +
  geom_histogram(binwidth = 15, fill = "lightblue", color = "black") +
  geom_vline(data = mean_delays_least, aes(xintercept = mean_delay), color = "red", linetype = "dashed", linewidth = 1) +
  facet_wrap(~ DEST, scales = "free_y", ncol = 3) +
  labs(
    title = "Distribution of Arrival Delay (min) for Least Delayed Destination Airports",
    x = "Arrival Delay (minutes)", 
    y = "Frequency"
  ) +
  # Reasonable range for delays
  # Include negative values for flights that arrived early
  xlim(-50, 100)
```

\pagebreak

### Flight delays grouped by DEP_TIME_BLK

```{r P1Q4_growth, echo=FALSE, fig.width = 8, fig.height = 4}

# Grouping Time Blocks into Segments
flight_delays_df <- flight_delays_df %>%
  mutate(
    Time_Segment = case_when(
      DEP_TIME_BLK %in% c("0001-0559", "0600-0659", "0700-0759", "0800-0859") ~ "A. Early Morning (00:00-08:59)",
      DEP_TIME_BLK %in% c("0900-0959", "1000-1059", "1100-1159", "1200-1259", "1300-1359", "1400-1459", "1500-1559") ~ "B. Mid-Day (09:00-15:59)",
      DEP_TIME_BLK %in% c("1600-1659", "1700-1759", "1800-1859", "1900-1959", "2000-2059") ~ "C. Peak Evening (16:00-20:59)",
      TRUE ~ "D. Late Night (21:00+)"
    )
  )
```

```{r, echo=FALSE, fig.width = 8, fig.height = 4}
ggplot(data = flight_delays_df, aes(x = Time_Segment, y = ARR_DELAY)) +
  geom_boxplot(aes(fill = Time_Segment)) +
  coord_cartesian(ylim = c(-30, 100)) + 
  labs(title = "Arrival Delay Distribution by Time Segment",
       x = "Time Segment",
       y = "Arrival Delay (minutes)") +
  # Rotate X-axis labels for better readability
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r P1Q4, echo=FALSE, fig.width = 6, fig.height = 3.5}

percentage_segment_summary <- flight_delays_df %>%
  filter(!is.na(Time_Segment)) %>%
  group_by(Time_Segment) %>%
  summarise(
    Total_Flights = n(),
    Total_Delayed = sum(ARR_DEL15, na.rm = TRUE),
    Percentage_Delayed = (Total_Delayed / Total_Flights) * 100
  ) %>%
  ungroup() %>%
  arrange(Percentage_Delayed) 

ggplot(data = percentage_segment_summary, 
       aes(x = reorder(Time_Segment, -Percentage_Delayed), 
           y = Percentage_Delayed, 
           fill = Time_Segment)) +
  
  geom_col(color = "black") + 
  geom_text(aes(label = paste0(round(Percentage_Delayed, 1), "%")), 
            vjust = -0.5, size = 4) +
    labs(title = "Risk of Flight Delay by Time of Day",
       subtitle = "Percentage of flights with Arrival Delay â‰¥ 15 minutes",
       x = "Time Segment",
       y = "Percentage of Flights Delayed (%)") +
    theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
    scale_y_continuous(limits = c(0, max(percentage_segment_summary$Percentage_Delayed) * 1.1))
```

\pagebreak

### Population growth of flight delays grouped by ARR_DELAY 

```{r, echo=FALSE, fig.width = 6, fig.height = 6}
flight_delays_df <- flight_delays_df %>%
  mutate(
    Delay_Segment = case_when(
      ARR_DELAY > 120 ~ "D. Large Delay (> 120 min)",
      ARR_DELAY > 45 ~ "C. Medium Delay (45 < Delay <= 120 min)",
      ARR_DELAY > 15 ~ "B. Small Delay (15 < Delay <= 45 min)",
      TRUE ~ "A. On-Time/Minor Delay (<= 15 min)"
    )
  )

ggplot(data = flight_delays_df, 
       aes(x = Delay_Segment, y = ARR_DELAY, fill = Delay_Segment)) +
  
  geom_boxplot(outlier.shape = NA) + 
  coord_cartesian(ylim = c(-30, 200)) + 
  labs(title = "Arrival Delay Distribution by Severity Segment",
       x = "Arrival Delay Severity Segment",
       y = "Arrival Delay (minutes)") +
  
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")
```

```{r P1Q5_growth_plot, echo=FALSE, fig.width = 6, fig.height = 6}
delay_composition_summary <- flight_delays_df %>%
  filter(!is.na(ARR_DELAY)) %>%
  group_by(Delay_Segment) %>%
  summarise(
    Total_Flights = n()
  ) %>%
  ungroup() %>%
  mutate(
    Percentage = (Total_Flights / sum(Total_Flights)) * 100
  ) %>%
  arrange(Delay_Segment)

ggplot(data = delay_composition_summary, 
       aes(x = Delay_Segment, y = Percentage, fill = Delay_Segment)) +
  geom_col(color = "black") + 
  geom_text(aes(label = paste0(round(Percentage, 1), "%")), 
            vjust = -0.5, size = 4) +
  labs(title = "Composition of Arrival Delay Severity",
       subtitle = "Percentage breakdown of all flights",
       x = "Arrival Delay Severity Segment",
       y = "Percentage of Total Flights (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") + 
    scale_y_continuous(limits = c(0, max(delay_composition_summary$Percentage) * 1.05))
```
\pagebreak

## LATE_AIRCRAFT_DELAY influencing Flight Delays

Examine how delays are caused by a previous event, showing how a "hotspot" spreads to the current flight (LATE_AIRCRAFT_DELAY)

```{r, echo=FALSE, fig.width = 8, fig.height = 4}
late_aircraft_delays_df <- flight_delays_df %>%
  filter(!is.na(LATE_AIRCRAFT_DELAY) & LATE_AIRCRAFT_DELAY > 0) %>%
  select(LATE_AIRCRAFT_DELAY)

ggplot(data = late_aircraft_delays_df, aes(x = LATE_AIRCRAFT_DELAY)) +
  geom_histogram(binwidth = 15, fill = "blue", color = "black") +   coord_cartesian(xlim = c(0, 300)) + 
  labs(
    title = "Severity of Delays Caused by Late Aircraft",
    subtitle = "Distribution of delay minutes attributed to LATE_AIRCRAFT_DELAY",
    x = "Late Aircraft Delay (Minutes)",
    y = "Count of Flights"
  ) +
  theme_minimal()
```

