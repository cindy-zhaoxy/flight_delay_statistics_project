---
title: "Group Project: Flight Delays"
author: "EDA Contribution: Cindy Zhao"
output: word_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
# This first chunk is for setup. 
# The 'include=FALSE' option means the code will run, but it won't be shown in the final document.
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## Summary

Project Proposal: Analyzing and Predicting Flight Delays Using Bureau of Transportation Statistics Data

This project analyzes and predicts U.S. airline flight delays using the Bureau of Transportation Statistics (BTS) On-Time Performance dataset.The data include around 70,000 flights from July 2025 with fields such as airline, airport, date, scheduled and actual times, delay durations, and causes (weather, carrier, system, and late aircraft).


Columns(35) include: YEAR MONTH DAY_OF_MONTH DAY_OF_WEEK FL_DATE MKT_UNIQUE_CARRIER ORIGIN ORIGIN_CITY_NAME ORIGIN_STATE_NM DEST DEST_CITY_NAME DEST_STATE_NM CRS_DEP_TIME DEP_TIME DEP_DELAY DEP_DELAY_NEW DEP_DEL15 DEP_TIME_BLK TAXI_OUT TAXI_IN CRS_ARR_TIME ARR_TIME ARR_DELAY ARR_DELAY_NEW ARR_DEL15 CANCELLED CANCELLATION_CODE DIVERTED AIR_TIME DISTANCE CARRIER_DELAY WEATHER_DELAY NAS_DELAY SECURITY_DELAY LATE_AIRCRAFT_DELAY

Delay Extremes: 

Identify airlines with the most and least delays (>15 min)
Identify airports with the most and least delays
Look at arrival delays (ARR_DEL15) and departure delays (DEP_DEL15)

Delay Duration Dynamics:

Analyze the distribution of delay times through histograms
Highlight airlines/airports with the highest and lowest average delay durations

Temporal and Operational Patterns:

Visualize how delays vary by time of day (using DEP_TIME_BLK)
Examine how delays are caused by a previous event, showing how a "hotspot" spreads to the current flight (LATE_AIRCRAFT_DELAY)

## Data

```{r load-data, echo=FALSE}

# Load Libraries and Data
library(tidyverse)
library(flextable)
library(gridExtra)
library(ggExtra)

flight_delays_df <- read.csv("T_ONTIME_MARKETING.csv")
```

### Preview the data set

```{r df preview, echo=FALSE}

flight_delays_df %>%
  select(1:10) %>% 
  head(3) %>%
  flextable() %>%
  set_caption("Flight delays (first 3 rows and first 10 columns of dataset)") %>%
  fontsize(size = 6, part = "all")
```

## Part 1: EDA (Exploratory Data Analysis) of arrival flight delays:

```{r EDA rates, echo=FALSE, fig.width=8, fig.height=3.5}
mean_delay_rate <- mean(flight_delays_df$ARR_DEL15, na.rm = TRUE) * 100 
median_delay_rate <- median(flight_delays_df$ARR_DEL15, na.rm = TRUE) * 100

daily_flights_summary <- flight_delays_df %>%
  group_by(DAY_OF_MONTH) %>%
  summarise(
    Total_Flights_Day = n(),
    Total_Delayed_Day = sum(ARR_DEL15, na.rm = TRUE),
    Daily_Delay_Percentage = (Total_Delayed_Day / Total_Flights_Day) * 100
  ) %>%
  ungroup() 

p1 <- ggplot(daily_flights_summary, aes(x = DAY_OF_MONTH, y = Daily_Delay_Percentage)) +
  geom_line(color = "steelblue", linewidth = 1) + 
  ggtitle("Daily Arrival Delay Percentage") +
  xlab("Day of Month (July 2025)") +
  ylab("Daily Delay Percentage (%)") +
  theme_minimal() +
  scale_x_continuous(breaks = seq(1, max(daily_flights_summary$DAY_OF_MONTH, na.rm = TRUE), by = 2))

p2 <- ggplot(daily_flights_summary, aes(x = Daily_Delay_Percentage)) +
  geom_histogram(binwidth = 1.5, fill = "steelblue", color = "black") + 
  geom_vline(aes(xintercept = mean(Daily_Delay_Percentage, na.rm = TRUE)), color = "red", linetype = "dashed", linewidth = 1) +
  labs(
    title = "Distribution of Daily Arrival Delay Percentages", 
    x = "Daily Delay Percentage (%)", 
    y = "Frequency (Days)"
  )

grid.arrange(p1, p2, ncol = 2)
```

\pagebreak

### Identify airlines with the most and least Arrival Delays (>15 min)

```{r P1Q1a, echo=FALSE} 

airline_delay_summary <- flight_delays_df %>%
  # Group by airline
  group_by(MKT_UNIQUE_CARRIER) %>%
  summarize(
    Total_Flights = n(),
    # Sum gives the total number of delays. 
    # ARR_DEL15 is 1 if a delay >= 15 min
    Total_Delayed_Flights = sum(ARR_DEL15, na.rm = TRUE),
    # Percentage of delayed flights
    Delay_Percentage = (Total_Delayed_Flights / Total_Flights) * 100
  )

# Airlines with the highest Delay_Percentage
most_delayed <- airline_delay_summary %>%
  arrange(desc(Delay_Percentage)) %>%
  slice_head(n = 9)

most_delayed %>%
  flextable() %>%
  set_caption("Airlines with the highest Delay_Percentage") %>%
autofit()
```
\pagebreak

```{r P1Q1b, echo=FALSE}
# Airline with the Lowest Delay_Percentage
least_delayed <- airline_delay_summary %>%
  arrange(Delay_Percentage) %>%
  slice_head(n = 9)

least_delayed %>%
  flextable() %>%
  set_caption("Airlines with the Lowest Delay_Percentage") %>%
autofit()
```

```{r overall_increase, echo=FALSE, fig.width = 8}

N_disp <- 9
top_delayed_carrier_codes <- most_delayed$MKT_UNIQUE_CARRIER 

daily_delay_trends <- flight_delays_df %>%
  filter(MKT_UNIQUE_CARRIER %in% top_delayed_carrier_codes) %>%
  group_by(MKT_UNIQUE_CARRIER, DAY_OF_MONTH) %>%
  summarise(
    Daily_Flights = n(),
    Daily_Delayed = sum(ARR_DEL15, na.rm = TRUE),
    Daily_Delay_Percentage = (Daily_Delayed / Daily_Flights) * 100,
    .groups = 'drop' 
  )

daily_delay_trends %>%
  ggplot(aes(x = DAY_OF_MONTH, y = Daily_Delay_Percentage, color = MKT_UNIQUE_CARRIER)) +
  geom_line(linewidth = 0.8, show.legend = FALSE) +
  facet_wrap(~ MKT_UNIQUE_CARRIER, scales = "free_y", ncol = 3) +
  labs(
    title = paste0("Airlines with the highest Arrival Delays (>15 min): Daily Percentages"),
    x = "Day of Month (July 2025)",
    y = "Daily Delay Percentage (%)"
  ) +
  theme_minimal()
```

### Identify destination airports with the most and least Arrival Delays (>15 min)

```{r P1Q2a, echo=FALSE} 

airport_delay_summary <- flight_delays_df %>%
  # Group by the Destination Airport
  group_by(DEST) %>%
  summarize(
    Total_Arrivals = n(),
    # Sum gives the total number of delays. 
    # ARR_DEL15 is 1 if a delay >= 15 min
    Total_Arrival_Delays = sum(ARR_DEL15, na.rm = TRUE),
    # Percentage of delayed flights
    Arrival_Delay_Percentage = (Total_Arrival_Delays / Total_Arrivals) * 100
  )

# Destination Airports with the highest Arrival_Delay_Percentage
most_delayed_arrivals <- airport_delay_summary %>%
  arrange(desc(Arrival_Delay_Percentage)) %>%
  slice_head(n = 9)

# Display the top 5 most delayed airports
most_delayed_arrivals %>%
  flextable() %>%
  set_caption("Destination Airports with the Highest Arrival Delay Percentage (>15 min)") %>%
  autofit()
```
\pagebreak

```{r P1Q2b, echo=FALSE}
# Destination Airports with the Lowest Arrival_Delay_Percentage
least_delayed_arrivals <- airport_delay_summary %>%
  arrange(Arrival_Delay_Percentage) %>%
  slice_head(n = 9)

# Display the top 5 least delayed airports
least_delayed_arrivals %>%
  flextable() %>%
  set_caption("Destination Airports with the Lowest Arrival Delay Percentage (>15 min)") %>%
  autofit()
```

```{r overall_increase_flights, echo=FALSE, fig.width = 8}

N_disp <- 9
top_delayed_airports <- most_delayed_arrivals$DEST 

daily_delay_trends_airports <- flight_delays_df %>%
  filter(DEST %in% top_delayed_airports) %>%
  group_by(DEST, DAY_OF_MONTH) %>%
  summarise(
    Daily_Flights = n(),
    Daily_Delayed = sum(ARR_DEL15, na.rm = TRUE),
    Daily_Delay_Percentage = (Daily_Delayed / Daily_Flights) * 100,
    .groups = 'drop' 
  )

daily_delay_trends_airports %>%
  ggplot(aes(x = DAY_OF_MONTH, y = Daily_Delay_Percentage, color = DEST)) +
  geom_line(linewidth = 0.8, show.legend = FALSE) +
  facet_wrap(~ DEST, scales = "free_y", ncol = 3) +
  labs(
    title = paste0("Destination airports with the highest Arrival Delays (>15 min): Daily Percentages"),
    x = "Day of Month (July 2025)",
    y = "Daily Delay Percentage (%)"
  ) +
  theme_minimal()
```

### Histograms for the Most Delayed Destination Airports

```{r P1Q3h, echo=FALSE, fig.width = 8, fig.height = 4}

top_delayed_origins <- most_delayed_arrivals$DEST
data_for_plot <- flight_delays_df %>%
  filter(DEST %in% top_delayed_origins) %>%
 # Filter out missing delay values
  filter(ARR_DEL15 == 1, !is.na(ARR_DELAY))
mean_delays <- data_for_plot %>%
  group_by(DEST) %>%
  summarize(mean_delay = mean(ARR_DELAY, na.rm = TRUE))

#Plot
ggplot(data = data_for_plot, aes(x = ARR_DELAY)) +
  geom_histogram(binwidth = 15, fill = "steelblue", color = "black") +
 # The vertical line to show the mean population value
  geom_vline(data = mean_delays, 
             aes(xintercept = mean_delay), 
             color = "red", linetype = "dashed", linewidth = 1) +
  facet_wrap(~ DEST, scales = "free_y", ncol = 3) +
  labs(
    title = "Distribution of Arrival Delay (min) for Most Delayed Destination Airports",
    x = "Arrival Delay (minutes)", 
    y = "Frequency"
  ) +
  # Reasonable range for delays (0 to 200 minutes)
  xlim(0, 200) 
```

### Histograms of annual growth rates with lowest average rates.

```{r P1Q3L, echo=FALSE, fig.width = 8, fig.height = 4}

least_delayed_origins <- least_delayed_arrivals$DEST
data_for_plot_least <- flight_delays_df %>%
  # Filter out missing delay values
  filter(DEST %in% least_delayed_origins, !is.na(ARR_DELAY))

mean_delays_least <- data_for_plot_least %>%
  group_by(DEST) %>%
  summarize(mean_delay = mean(ARR_DELAY, na.rm = TRUE))

#Plot
ggplot(data = data_for_plot_least, aes(x = ARR_DELAY)) +
  geom_histogram(binwidth = 15, fill = "lightblue", color = "black") +
  geom_vline(data = mean_delays_least, aes(xintercept = mean_delay), color = "red", linetype = "dashed", linewidth = 1) +
  facet_wrap(~ DEST, scales = "free_y", ncol = 3) +
  labs(
    title = "Distribution of Arrival Delay (min) for Least Delayed Destination Airports",
    x = "Arrival Delay (minutes)", 
    y = "Frequency"
  ) +
  # Reasonable range for delays
  # Include negative values for flights that arrived early
  xlim(-50, 100)
```

### Population growth of flight delays grouped by Weather.

### Population growth of flight delays grouped by DEP_TIME_BLK. 

## Part 2: EDA (Exploratory Data Analysis) of Departure Delays:

## Other Factors influencing growth: DEP_TIME_BLK and LATE_AIRCRAFT_DELAY
